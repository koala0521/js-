/*
****中医基地-专业科室用户模块
****startTime：2017-3-31 
****author:gaopengfei
*/
;(function(){
		
	var $creatE ,$pTo;
	
	$creatE = Elf.controls.createElement;
	$pTo = Elf.controls.appendTo;
	
/***** 专业科室 > 专业科室基本情况表4 ******/
	;(function(){
		
		var jbzlGridHead = [
			{
				title:"编号",
				name:"",
				width:48,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					return '<div class="fixedCell">'+ (rowIndex+1) +'</div>';
				}
			},		
			{
				title:"疾病种类",
				name:"",
				width:200,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					return '<div>'+ rowData.grandson.field1 ? rowData.grandson.field1 :""  +'</div>';
				}
			},	
			{
				title:"年诊治例数",
				name:"",
				width:100,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					
					if( rowData.grandson.field2 == 0 || rowData.grandson.field2 ){
						
						return '<div>'+ rowData.grandson.field2 +'</div>';
					}else{
						
						return '';						
						
					}
				

				}
			},
			{
	    		title:"操作"
	    		,name:""
	    		,width:150
	    		,align:"center"
	    		,renderer:function(name,rowIndex,rowData){

	    			return '<input type="button" data-tooltip="删除第'+(rowIndex+1)+'行"'+' class="btn line-h30 prl6 delete elf-tooltip-left" value="删除" /><input type="button" class="edit prl6 btn line-h30" value="编辑" />'
	    		}
	    }
		
		];
		var stGridHead = [
			{
				title:"编号",
				name:"",
				width:48,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					return '<div class="fixedCell">'+ (rowIndex+1) +'</div>';
				}
			},		
			{
				title:"临床技能操作/手术种类",
				name:"",
				width:200,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					return '<div>'+ rowData.grandson.field1 ? rowData.grandson.field1 :"" +'</div>';
				}
			},	
			{
				title:"年完成例数",
				name:"",
				width:100,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					
					if( rowData.grandson.field2 == 0 || rowData.grandson.field2 ){
						
						return '<div>'+ rowData.grandson.field2 +'</div>';
					}else{
						
						return '';						
						
					}
				}
			},
			{
	    		title:"操作"
	    		,name:""
	    		,width:150
	    		,align:"center"
	    		,renderer:function(name,rowIndex,rowData){

	    			return '<input type="button" class="btn line-h30 prl6 delete elf-tooltip-left" value="删除" /><input type="button" class="edit prl6 btn line-h30" value="编辑" />'
	    		}
	    }
		
		];		
		var meGridHead = [
			{
				title:"编号",
				name:"",
				width:48,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					return '<div class="fixedCell">'+ (rowIndex+1) +'</div>';
				}
			},		
			{
				title:"设备仪器名称（正常使用）",
				name:"",
				width:200,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					console.log( rowData.grandson.field1);
					return '<div>'+ rowData.grandson.field1 ? rowData.grandson.field1 :"" +'</div>';
				}
			},	
			{
				title:"数量（台）",
				name:"",
				width:100,
				align:"center",
				fixedColumn:false,
				checkCol:false,
				valign:"middle",
				renderer:function(name,rowIndex,rowData){
					
					if( rowData.grandson.field2 == 0 || rowData.grandson.field2 ){
						
						return '<div>'+ rowData.grandson.field2 +'</div>';
					}else{
						
						return '';						
						
					}
				}
			},
			{
	    		title:"操作"
	    		,name:""
	    		,width:150
	    		,align:"center"
	    		,renderer:function(name,rowIndex,rowData){

	    			return '<input type="button" class="btn line-h30 prl6 delete elf-tooltip-left" value="删除" /><input type="button" class="edit prl6 btn line-h30" value="编辑" />'
	    		}
	    }		
		
		];

	
		//查询数据
		function getBaseData( _this , fDepartmentCode) {
		    var args = {};
		    args.fType = "20";
			args.fTableNumber = "departmentBasic";
		    var service = {
		        serviceModule: serviceInfo.serviceModule,
		        serviceNumber: '100090080',
		        token: use_info.token,
		        args: {"parent":args, fDepartmentCode:fDepartmentCode}
		    };
	
		    commonLogic.serviceCaller(service, function (data) {
		        
		        //console.log(JSON.stringify(data));
		        if(data.flag == "true"){
		        	console.log( data );		
					_this.init( data );
					
	
		        }else{
		        	
		            Elf.components.toast({text:data.error});
		        }
		    });
		}
		
		//发送数据
		function subEditBaseData( args , _this ) {
		    var service = {
		        serviceModule: serviceInfo.serviceModule,
		        serviceNumber: '100090090',
		        token: use_info.token,
		        args: args
		    };
		    commonLogic.serviceCaller(service, function (data) {
		        //console.log(JSON.stringify(data));
		        //alert(data.flag);
		        if(data.flag == "true"){
		            //alert(data.result);
				    Elf.components.toast({
				        holdtime:500,
				        text:'修改成功',
				        target:document.body
				    });	

		        }else{
		            Elf.components.toast({text:data.error});
		        }
		    });
		}	


		function BasiSituation4(fDepartmentCode){
			
			this.content = document.querySelector(".elf_fiexd_center");
			this.warp = $creatE('div' ,'grid4 full p10');
			this.form = $creatE('form','full');
			var _this = this;
			
			getBaseData(_this, fDepartmentCode);
			
		}
		
		//专业科室基本情况表4接口
		zyjdModuleByGao.basiSituation4 = BasiSituation4;
		
		BasiSituation4.prototype.init = function(data){
											
			data.result.parent = {"fTableNumber":"departmentBasic"};
			
			if( !data.result.fDepartmentCode && data.result.fDepartmentCode != 0 ){
				
				data.result.fDepartmentCode = "";
				
			}
			
			if( !data.result.fChildrenId && data.result.fChildrenId != 0 ){
				
				data.result.fChildrenId = "";
				
			}			
			
			
			if( !data.result.childrenList.length ){
			
				data.result.childrenList = [   
					{
		                "children":{"fOrder":0},
		                "grandsonList":[]
		            },
					{
		                "children":{"fOrder":1},
		                "grandsonList":[]
		            },				{
		                "children":{"fOrder":2},
		                "grandsonList":[]
		            }			
				];				
				
			}
			
			this.creatGrid4(data);

		}
		
		//生成表格
		BasiSituation4.prototype.creatGrid4 = function(data){
			var _this = this;
			
			Elf.components.ajax({
				
				url:"ZYJD-professional-grid4.html",
				dataType:"html",
//				data:{id:1,ccc:"ccc"},				
				success:function(strData){
					
					_this.warp.innerHTML = strData;
					_this.content.innerHTML = '';
					Elf.controls.appendTo( _this.warp, _this.form);
					Elf.controls.appendTo( _this.form, _this.content);
					//请求数据	
					_this.randerInfo( data );
					_this.btnFn( data );
					_this.addInfo( data);
					_this.hideBtns();
				},
				error:function(xhr){
					
					console.info(xhr);
				}
			});			
			
		}
		
		//按钮事件
		BasiSituation4.prototype.btnFn = function( data ){
			
			var _this = this;			
			this.warp.addEventListener('click', function(ev){
		
				var has,
					e,
					tt,
					infoObj,
					radios,
					isChecked,
					allInput;
					
				has = Elf.utils.hasClass;		
				e = Elf.getEvent(ev);
				tt = Elf.getEventSource(ev);
				isChecked = false;
							
				radios = this.getElementsByClassName('is-importent');
				allInput = this.querySelectorAll('input.text');
				
				//保存数据
				if( has( tt , 'save-data' ) ){
					
					
					infoObj = _this.getFormData( data );
					
					console.log( infoObj );
					//发送后台数据
					subEditBaseData( infoObj , _this );
				
					return
				}
				
				//提交数据按钮
				if( has( tt , 'submit-data' ) ){
					
					//验证radio非空
					for (var i = 0; i < radios.length; i++) {
						
						if( radios[i].checked ){
							
							isChecked = true;
							break;
						}

					}
					if( !isChecked ){

						Elf.utils.addClass( radios[0].parentNode , "focus");

					    Elf.components.toast({
					        holdtime:1000,
					        text:'请填写完整信息',
					        opacity:0.8,
					        target:document.body
					    });							
						
						return
						
					}else{
						
						Elf.utils.removeClass( radios[0].parentNode , "focus");
					}
					
					//验证text非空
					for (var i = 0; i < allInput.length; i++) {
						
						if(  Elf.utils.trim( allInput[i].value ) === '' ){
							
							allInput[i].focus();
								
						    Elf.components.toast({
						        holdtime:1000,
						        text:'请填写完整信息',
						        opacity:0.8,
						        target:document.body
						    });	
						    
						    return
						}
					
					}
			 		var re = /\D+/g;					
					var numbers = this.querySelectorAll('input.number');
					for (var i = 0; i < numbers.length; i++) {
						
						if( re.test( Elf.utils.trim(numbers[i].value) ) ){
							
							numbers[i].focus();

					    Elf.components.toast({
					        holdtime:1000,
					        text:'请输入数字',
					        opacity:0.8,
					        target:document.body
					    });
							return
						}
						
					}
					
					infoObj = _this.getFormData( data );
					//发送后台数据
					subEditBaseData( infoObj , _this );
				    
					return
				}

				
			})
		}
		
		//隐藏按钮
		BasiSituation4.prototype.hideBtns = function(){
			var hash,
				btns,
				inputs;
				
			hash = window.location.hash.substring(1);	
			btns = this.warp.querySelectorAll('input.btn');
			inputs = this.warp.querySelectorAll('input');	
			
			if( hash.indexOf('newPage') !== -1 ){
								
				for (var i = 0; i < inputs.length; i++) {
					inputs[i].disabled = 'disabled';
				}			
				for (var i = 0; i < btns.length; i++) {
					
					Elf.effects.hidden(btns[i]);
				}			
			}
		}
		
		//渲染表单
		BasiSituation4.prototype.randerInfo = function(data){
			var data,
				objTexts,
				radios,
				diseaseTypeWarp,
				skillTypeWarp,
				medicalEquipment,
				_this,
				dialog,
				dialogHtml,
				dataList,
				textsData,
				gridData1,
				gridData2,
				gridData3;
				
			_this = this;
			data = data;			
			dataList = data.result.childrenList;

			for (var i = 0; i < dataList.length; i++) {
				
				if( dataList[i].children.fOrder == 0 ){
					
					textsData = dataList[i].children;
					gridData1 = dataList[i].grandsonList;
					
				}else if ( dataList[i].children.fOrder == 1 ){
					
					gridData2 = dataList[i].grandsonList;
					
					
				}else if( dataList[i].children.fOrder == 2 ){
					
					gridData3 = dataList[i].grandsonList;
					
				}
			}
  
			objTexts = this.warp.getElementsByClassName('objText');
			raudioWarp = this.warp.querySelector('span.audio-warp');
			radios = this.warp.getElementsByClassName('is-importent');
			diseaseTypeWarp = this.warp.querySelector('.disease-type-warp');
			skillTypeWarp = this.warp.querySelector('.skill-type-warp');
			medicalEquipment = this.warp.querySelector('.medical-equipment-warp');
			
			//单选按钮
			for (var i = 0; i < radios.length; i++) {
				
				if( radios[i].value == textsData.field8 ){
					console.log( raudioWarp );
					radios[i].checked = "checked";
					Elf.utils.addClass( raudioWarp , 'has-value');
				}
			}
			//其他基础数据
			for (var i = 0; i < objTexts.length; i++) {
				
				objTexts[i].value = textsData[objTexts[i].name]?textsData[objTexts[i].name]:'';
				
				if( Elf.utils.trim( objTexts[i].value ) !== '' ){
						
						Elf.utils.addClass( objTexts[i], 'has-value');
											
				}
				
				objTexts[i].addEventListener('blur',function(){

					var _this = this;
					if( Elf.utils.trim( _this.value ) === '' ){
						
						Elf.utils.removeClass(_this , 'has-value');
											
					}else{
						
						Elf.utils.addClass(_this , 'has-value');
						
					}
					
				})
			}
		
			//疾病种类				
		    this.dtGrid = Elf.components.grid({
		        fixedTableSize:30,  
		        data:gridData1? gridData1.slice(0 , Infinity) : [],    //第一页要显示的数据
		        cols:jbzlGridHead,   
		        width: 40,
		        target:diseaseTypeWarp, 
		        onCellSelected:function(evt,item,rowIndex,colIndex){
		            var tt=evt.target;          // 事件源
		            
		            if(Elf.utils.hasClass(tt,"delete")){ 

		                item.grandson.fIsDel = 1;
		                
		                var filterArr = Elf.utils.grep( gridData1 , function( item , index ){
		                	
		                	return item.grandson.fIsDel == 0;
		                })		
		                
		                Elf.components.grid.methods.update( _this.dtGrid , filterArr );
		                
		            }
		            if(Elf.utils.hasClass(tt,"edit")){ 
		                
		                dialogHtml = '<div class="h40 line-h40 mt50" ><div class="col-xs-6 textr" ><span class="name" >疾病种类：</span></div><div class="col-xs-6 " ><input type="text" class="text p5 line-h20 textc" value= "'+ item.grandson.field1 +'"  name="field1" /></div></div><div class="h40 line-h40 mt20" ><div class="col-xs-6 textr" ><span class="num" >年诊治例数：</span></div><div class="col-xs-6 " ><input type="text" class="text p5 line-h20 textc" value= "'+ item.grandson.field2 +'"  name="field2" /></div></div><div class="h40 line-h40 mt20" ></div><div class="h40 line-h40 mt20 textc" ><input type="button" class="btn prl24 line-h30" value="确定" /></div>';
		                
		                dialog = Elf.components.dialog({
					        title:'修改',   
					        content:dialogHtml, 
					        dialogClass:'',  
					        width:600,  
					        height:360,
					        modal:true,    //是否显示遮罩层
				            target:_this.warp,   
					        onCloseDestroy:true,     
					        onClose:function(){

					        }
					    });
						
						dialog.addEventListener('click',function(ev){
							
							var has,
								e,
								tt,
								infoObj,
								radios,
								isChecked,
								allInput;
								
							has = Elf.utils.hasClass;		
							e = Elf.getEvent(ev);
							tt = Elf.getEventSource(ev);
							allInput = this.querySelectorAll('input.text');
							
							if( has( tt , 'btn' ) ){
								
								for (var i = 0; i < allInput.length; i++) {
									
									if( Elf.utils.trim( allInput[i].value ) === '' ){
										
										allInput[i].focus();
									    Elf.components.toast({
									        holdtime:1000,
									        text:'请填写完整信息！',
									        opacity:0.8,
									        target:document.body
									    });										
										return
									}
								}
								for (var i = 0; i < allInput.length; i++) {
								
									item.grandson[allInput[i].name] = allInput[i].value;
								}

		               			Elf.components.grid.methods.update( _this.dtGrid , gridData1 );								
		               			Elf.utils.remove(this);
		               			
		               			console.log( dataList );
		               			
							}
							
						})
		            
		            }
		            
		        }
		     });
			
			//临床技能
		    this.stGrid = Elf.components.grid({
		        fixedTableSize:30,  
		        data: gridData2 ? gridData2.slice(0 , Infinity):[],    
		        cols:stGridHead,   
		        width: 40,
		        target:skillTypeWarp, 
		        onCellSelected:function(evt,item,rowIndex,colIndex){
		            var tt=evt.target;     
		            if(Elf.utils.hasClass(tt,"delete")){   
		            	
		                item.grandson.fIsDel = 1;
		                
		                var filterArr = Elf.utils.grep( gridData2 , function( item , index ){
		                	
		                	return item.grandson.fIsDel == 0;
		                })	
		                
		                Elf.components.grid.methods.update( _this.stGrid , filterArr );
		            }
		            if(Elf.utils.hasClass(tt,"edit")){  //判断事件源是否是 编辑 按钮
		                console.info("编辑行");
		                
		                dialogHtml = '<div class="h40 line-h40 mt50" ><div class="col-xs-6 textr" ><span class="name" >临床技能操作/手术种类：</span></div><div class="col-xs-6 " ><input type="text" class="text p5 line-h20 textc" value= "'+ item.grandson.field1 +'"  name="field1" /></div></div><div class="h40 line-h40 mt20" ><div class="col-xs-6 textr" ><span class="num" >年完成例数：</span></div><div class="col-xs-6 " ><input type="text" class="text p5 line-h20 textc" value= "'+ item.grandson.field2 +'"  name="field2" /></div></div><div class="h40 line-h40 mt20" ></div><div class="h40 line-h40 mt20 textc" ><input type="button" class="btn prl24 line-h30" value="确定" /></div>';
		                
		                dialog = Elf.components.dialog({
					        title:'修改',   
					        content:dialogHtml, 
					        dialogClass:'', 
					        width:600,  
					        height:360,
					        modal:true,  
				            target:_this.warp,  
					        onCloseDestroy:true, 
					        onClose:function(){
					            
					        }
					    });
						
						dialog.addEventListener('click',function(ev){
							
							var has,
								e,
								tt,
								infoObj,
								radios,
								isChecked,
								allInput;
								
							has = Elf.utils.hasClass;		
							e = Elf.getEvent(ev);
							tt = Elf.getEventSource(ev);
							allInput = this.querySelectorAll('input.text');
							
							if( has( tt , 'btn' ) ){
								
								for (var i = 0; i < allInput.length; i++) {
									
									if( Elf.utils.trim( allInput[i].value ) === '' ){
										
										allInput[i].focus();
									    Elf.components.toast({
									        holdtime:1000,
									        text:'请填写完整信息！',
									        opacity:0.8,
									        target:document.body
									    });										
										return
									}
								}
								for (var i = 0; i < allInput.length; i++) {
								
									item.grandson[allInput[i].name] = allInput[i].value;
								}

		               			Elf.components.grid.methods.update( _this.stGrid , gridData2 );								Elf.utils.remove(this);
		               			
							}
							
						})
		            		                
		            }
		        }
		     });
			//设备仪器名称
		    this.meGrid = Elf.components.grid({
		        fixedTableSize:30,  
		        data:gridData3 ? gridData3.slice(0 , Infinity):[],    
		        cols:meGridHead,   
		        width: 40,
		        target:medicalEquipment, 
		        onCellSelected:function(evt,item,rowIndex,colIndex){
		            var tt=evt.target; 
		            var itemObj = item;
		        
		            if(Elf.utils.hasClass(tt,"delete")){  
		            	

		                item.grandson.fIsDel = 1;
		                var filterArr = Elf.utils.grep( gridData3 , function( item , index ){
		                	
		                	return item.grandson.fIsDel == 0;
		                })
		                
		                Elf.components.grid.methods.update( _this.meGrid , filterArr );
		            }
		            if(Elf.utils.hasClass(tt,"edit")){ 
		                
		                dialogHtml = '<div class="h40 line-h40 mt50" ><div class="col-xs-6 textr" ><span class="name" >临床技能操作/手术种类：</span></div><div class="col-xs-6 " ><input type="text" class="text p5 line-h20 textc" value= "'+ item.grandson.field1 +'"  name="field1" /></div></div><div class="h40 line-h40 mt20" ><div class="col-xs-6 textr" ><span class="num" >年完成例数：</span></div><div class="col-xs-6 " ><input type="text" class="text p5 line-h20 textc" value= "'+ item.grandson.field2 +'"  name="field2" /></div></div><div class="h40 line-h40 mt20" ></div><div class="h40 line-h40 mt20 textc" ><input type="button" class="btn prl24 line-h30" value="确定" /></div>';
		                
		                dialog = Elf.components.dialog({
					        title:'修改',  
					        content:dialogHtml, 
					        dialogClass:'',  
					        width:600,  
					        height:360,
					        modal:true,    
				            target:_this.warp,  
					        onCloseDestroy:true, 
					        onClose:function(){
					            
					        }
					    });
						
						dialog.addEventListener('click',function(ev){
							
							var has,
								e,
								tt,
								infoObj,
								radios,
								isChecked,
								allInput;
								
							has = Elf.utils.hasClass;		
							e = Elf.getEvent(ev);
							tt = Elf.getEventSource(ev);
							allInput = this.querySelectorAll('input.text');
							
							if( has( tt , 'btn' ) ){
								
								for (var i = 0; i < allInput.length; i++) {
									
									if( Elf.utils.trim( allInput[i].value ) === '' ){
										
										allInput[i].focus();
									    Elf.components.toast({
									        holdtime:1000,
									        text:'请填写完整信息！',
									        opacity:0.8,
									        target:document.body
									    });										
										return
									}
								}
								for (var i = 0; i < allInput.length; i++) {
								
									item.grandson[allInput[i].name] = allInput[i].value;
								}

		               			Elf.components.grid.methods.update( _this.meGrid , gridData3 );								
		               			Elf.utils.remove(this);
		               			
							}
							
						})
		            			                
		                
		            }
		        }
		    });		
		}
		
		//获取表单数据
		BasiSituation4.prototype.getFormData = function( data ){
			
			var objTexts,
				childrenList,
				infoObj,
				radios,
				isChecked,
				allInput,
				TextsData;
				
			objTexts = this.warp.getElementsByClassName('objText');				
			radios = this.warp.getElementsByClassName('is-importent');
			allInput = this.warp.querySelectorAll('input.text');
			isChecked = false;
			childrenList = data.result.childrenList;

			for (var i = 0; i < childrenList.length; i++) {
				
				if( childrenList[i].children.fOrder == 0 ) {
				
					TextsData = childrenList[i].children;
					
				}
			}
			
			//基础数据
			for (var i = 0; i < objTexts.length; i++) {
				
				TextsData[objTexts[i].name] = objTexts[i].value;
			
			}

			//单选按钮数据
			for (var i = 0; i < radios.length; i++) {
				
				if( radios[i].checked ){
					
					isChecked = true;
					TextsData[radios[i].name] = radios[i].value;
					break;
				}
				
			}	
			
			return data.result;
		
		}
		
		//添加数据
		BasiSituation4.prototype.addInfo = function(data){
			
			var data = data,
				typeList = data.result.childrenList,
				_this = this;

			this.warp.addEventListener('click' , function(ev){
				
				var has,
					e,
					tt,
					dialog,
					dialogHtml,
					spanName,
					spanNum,
					inputName,
					inputNum,
					saveAdd;

				has = Elf.utils.hasClass;		
				e = Elf.getEvent(ev);
				tt = Elf.getEventSource(ev);

				
				dialogHtml = '<div class="h40 line-h40 mt50" ><div class="col-xs-6 textr" ><span class="name" ></span></div><div class="col-xs-6 " ><input type="text" class="text name p5 line-h20 textc" name="field1" /></div></div><div class="h40 line-h40 mt20" ><div class="col-xs-6 textr" ><span class="num" ></span></div><div class="col-xs-6 " ><input type="text" name="field2"  class="text num p5 line-h20 textc" /></div></div><div class="h40 line-h40 mt20" ></div><div class="h40 line-h40 mt20 textc" ><input type="button" class="btn save-add prl24 line-h30" value="确定" /></div>';
				
				if( has( tt ,'addrow') ){
					
	                dialog = Elf.components.dialog({
				        title:'添加信息',   
				        content:dialogHtml, 
				        dialogClass:'',  
				        width:600,  
				        height:360,
				        modal:true,    
			            target:_this.warp,   
				        onCloseDestroy:true,     
				        onClose:function(){

				        }
				    });	
					
					spanName = dialog.querySelector('span.name');
					spanNum = dialog.querySelector('span.num');
					inputName = dialog.querySelector('input.name');
					inputNum = dialog.querySelector('input.num');
					saveAdd = dialog.querySelector('input.save-add');
					
					if( has( tt , 'disease-type' ) ){

						spanName.innerHTML = '疾病种类：';
						spanNum.innerHTML = '年诊治例数（例）：';

						Elf.utils.attr( saveAdd , 'data-type' , 'disease-type' );
						
					}else if( has( tt , 'skill-type' ) ){

						spanName.innerHTML = '临床技能操作/手术种类：';
						spanNum.innerHTML = '年完成例数（例）：';	
	
						Elf.utils.attr( saveAdd , 'data-type' , 'skill-type' );			
						
					}else if( has( tt , 'medical-equipment' ) ){
						
						spanName.innerHTML = '设备仪器名称（正常使用）：';
						spanNum.innerHTML = '数量（台）：';		
	
						Elf.utils.attr( saveAdd , 'data-type' , 'medical-equipment' );						
					}
				
					//添加确认
					saveAdd.addEventListener('click' , function(){
							
						var has,
							e,
							tt,
							obj;
		
						has = Elf.utils.hasClass;		
						e = Elf.getEvent(ev);
						tt = Elf.getEventSource(ev);
						obj ={};
						if( Elf.utils.trim( inputName.value ) === '' ){				
							
							inputName.focus();							
						    Elf.components.toast({
						        holdtime:1000,
						        text:'请填写完整！',
						        opacity:0.8,
						        target:document.body
						    });	
						    
							return	
						}
						
						if( Elf.utils.trim( inputNum.value ) === '' ){				
							
							inputNum.focus();							
						    Elf.components.toast({
						        holdtime:1000,
						        text:'请填写完整！',
						        opacity:0.8,
						        target:document.body
						    });	
						    
							return	
						}
						
						if( Elf.utils.attr( saveAdd , 'data-type') === 'disease-type' ){
							
							obj.grandson = {
								"field1":inputName.value,
								"field2":inputNum.value								
							};							
							
							for (var i = 0; i < typeList.length; i++) {
								
								if( typeList[i].children.fOrder == 0 ){
									
									typeList[i].grandsonList.push(obj);
												
									Elf.components.grid.methods.update( _this.dtGrid , typeList[i].grandsonList );									
									break;
								}

							}

							
						}else if( Elf.utils.attr( saveAdd , 'data-type') === 'skill-type' ){
							
							obj.grandson = {
								
								"field1":inputName.value,
								"field2":inputNum.value								
							};							

							for (var i = 0; i < typeList.length; i++) {
								
								if( typeList[i].children.fOrder == 1 ){
									
									typeList[i].grandsonList.push(obj);	
									Elf.components.grid.methods.update( _this.stGrid , typeList[i].grandsonList );								
									break;
								}

							}
							
						}else if( Elf.utils.attr( saveAdd , 'data-type') === 'medical-equipment' ){
							
							obj.grandson = {
								
								"field1":inputName.value,
								"field2":inputNum.value
							};

							for (var i = 0; i < typeList.length; i++) {
								
								if( typeList[i].children.fOrder == 2 ){
									console.log( typeList[i].grandsonList );
									typeList[i].grandsonList.push(obj);	
									Elf.components.grid.methods.update( _this.meGrid , typeList[i].grandsonList );								
									break;
								}

							}						

						}	
						
						Elf.utils.remove( dialog );											

					});					
	
				}

				
			});
			
		}
		
	})();
	
/***** 专业科室 > 专业科室基本情况表5 ******/	
	;(function(){
		
	
		//查询数据
		function getBaseData( _this ) {
		    var args = {};
		    args.fType = "20";
		    args.fTableNumber = "departmentTeacher";
		    var service = {
		        serviceModule: serviceInfo.serviceModule,
		        serviceNumber: '100090080',
		        token: use_info.token,
		        args: {"parent":args}
		    };
	
		    commonLogic.serviceCaller(service, function (data) {
		        
		        //console.log(JSON.stringify(data));
		        if(data.flag == "true"){
		        	
		        	console.log( args , data );
					
					_this.init( data );
					
	
		        }else{
		            Elf.components.toast({text:data.error});
		        }
		    });
		}
		
		//发送数据
		function subEditBaseData( args , _this ) {
		    var service = {
		        serviceModule: serviceInfo.serviceModule,
		        serviceNumber: '100090090',
		        token: use_info.token,
		        args: args
		    };
		    commonLogic.serviceCaller(service, function (data) {
		        //console.log(JSON.stringify(data));

		        if(data.flag == "true"){
		            //alert(data.result);
				    Elf.components.toast({
				        holdtime:500,
				        text:'保存成功',
				        target:document.body
				    });	
	
				    //渲染数据
					getBaseData( _this );

		        }else{
		            Elf.components.toast({text:data.error});
		        }
		    });
		}			
		
		
		function BasiSituation5(){
			
			this.content = document.querySelector(".elf_fiexd_center");
			this.form = $creatE('form','full');
			this.warp = $creatE('div' ,'grid5 full p10');
			
			getBaseData(this);

		}
		
		//专业科室基本情况表5接口
		zyjdModuleByGao.basiSituation5 = BasiSituation5;
		
		BasiSituation5.prototype.init = function( data ){
			
			var dataList = data.result.childrenList;
			data.result.parent.fTableNumber = data.result.parent.fTableNumber || "departmentTeacher";
			
			
			if( !data.result.fDepartmentCode && data.result.fDepartmentCode != 0 ){
				
				data.result.fDepartmentCode = "";
				
			}
			
			if( !data.result.fChildrenId && data.result.fChildrenId != 0 ){
				
				data.result.fChildrenId = "";
				
			}				
			
			if( !dataList.length ){
				
				var obj = {
						"children":{
							
							"fOrder":0
						},
						
						"grandsonList":[]
					}
				
				data.result.childrenList.push(obj);

			}

			this.creatGrid5(data);
		}
		
		//生成表格
		BasiSituation5.prototype.creatGrid5 = function(dataObj){
			var _this = this;
			var getData = dataObj;
			Elf.components.ajax({
				
				url:"zyjd-professional-grid5.html",
				dataType:"html",
//				data:{id:1,ccc:"ccc"},				
				success:function(data){
					
					_this.warp.innerHTML = data;
					_this.content.innerHTML = '';						
					Elf.controls.appendTo( _this.warp, _this.form);				
					Elf.controls.appendTo( _this.form, _this.content);					

					_this.randerData( getData );
					_this.btnFn( getData );
					_this.removeRow( getData );
					_this.hideBtns();
				
				},
				error:function(xhr){
					
					console.info(xhr);
				}
			});			
			
		}
		
		//渲染数据
		BasiSituation5.prototype.randerData = function( dataObj ){
			var rows = this.warp.querySelectorAll('.row');
			var gridBodyWarp = this.warp.querySelector('.grid-body');
			var rowHtml = "";			
			var allText = null;
			
			var dataArr1 = dataObj.result.childrenList[0].grandsonList;

			var dataArr =  Elf.utils.grep( dataArr1 ,function( item , index ){

				return  item.grandson.fIsDel == 0;
			});

			for (var i = 0; i < dataArr.length; i++) {
				
				dataArr[i].grandson = dataArr[i].grandson || {};	
				rowHtml += '<div class="row wfull h40 line-h40 clear-fix" data-index='+ ( i + 1) +' ><div class="col-xs-4 hfull" ><div class="col-xs-3 ceils hfull" ><input class="text w80" type="text" name="field1" value="'+( dataArr[i].grandson.field1 || "" )+'"  /></div><div class="col-xs-2 ceils hfull" ><input class="text" type="text" name="field2" value="'+( dataArr[i].grandson.field2 || "" )+'"  /></div><div class="col-xs-2 ceils hfull" ><input class="text" type="text" name="field3" value="'+( dataArr[i].grandson.field3 || "" )+'"  /></div><div class="col-xs-2 ceils hfull" ><input class="text" type="text" name="field4" value="'+( dataArr[i].grandson.field4 ||"" )+'" /></div><div class="col-xs-3 ceils hfull" ><input class="text w80" type="text" name="field5" value="'+( dataArr[i].grandson.field5 || "" )+'" /></div></div><div class="col-xs-3 hfull" ><div class="col-xs-5 ceils hfull "><input class="text w80" type="text" name="field6" value="'+( dataArr[i].grandson.field6 || "" )+'" /></div><div class="col-xs-3 ceils hfull "><input class="text" type="text" name="field7" value="'+  ( dataArr[i].grandson.field7 || "" ) +'" /></div><div class="col-xs-4 ceils hfull "><input class="text" type="text" name="field8" value="'+( dataArr[i].grandson.field8 || "" )+'" /></div></div><div class="col-xs-4 hfull" ><div class="col-xs-2 ceils hfull"><input class="text" type="text" name="field9" value="'+ ( dataArr[i].grandson.field9 || "" )+'" /></div><div class="col-xs-2 ceils hfull"><input class="text" type="text" name="field10" value="'+ ( dataArr[i].grandson.field10 || "" ) +'" /></div><div class="col-xs-2 ceils hfull"><input class="text" type="text" name="field11" value="'+ ( dataArr[i].grandson.field11 || "" ) +'" /></div><div class="col-xs-2 ceils hfull"><input class="text" type="text" name="field12" value="'+ ( dataArr[i].grandson.field12 || "" ) +'" /></div><div class="col-xs-4 ceils hfull" ><input class="text" type="text" name="field13" value="'+ ( dataArr[i].grandson.field13 || "" ) +'" /></div></div><div class="col-xs-1 borderr hfull textc ceils"><input class="btn prl12 line-h30 removerow" type="button" value="删除" /></div></div>';
				
			}
			
			if( rowHtml !== '' ){

				gridBodyWarp.innerHTML = rowHtml;					
			}
			
			allText = this.warp.querySelectorAll('input.text');
			for (var i = 0; i < allText.length; i++) {

				if( Elf.utils.trim( allText[i].value ) !== '' ){

					Elf.utils.addClass( allText[i] , 'has-value');
				}
				
				allText[i].addEventListener('blur',function(){
					
					if( Elf.utils.trim( this.value ) !== '' ){
						
						Elf.utils.addClass( this , 'has-value');
					}else{
						
						Elf.utils.removeClass( this , 'has-value');
						
					}
					
				});
			}
		}
		
		//按钮绑定事件
		BasiSituation5.prototype.btnFn = function( dataObj ){
			var _this = this;
			var data = dataObj;
			var dataArr = dataObj.result.childrenList[0].grandsonList;

			this.warp.addEventListener('click', function(ev){
		
				var has,
					e,
					tt,
					infos,
					infoRows,
					oneInfo,
					infoArr;
					
				has = Elf.utils.hasClass;		
				e = Elf.getEvent(ev);
				tt = Elf.getEventSource(ev);
				//整个数据

				infoArr = [];

				
				infoRows = this.getElementsByClassName('row');
				
				if( has( tt , 'save-data' ) ){

					for (var i = 0; i < infoRows.length; i++) {
						infos = infoRows[i].getElementsByClassName('text');
						
						for (var j = 0; j < infos.length; j++) {
							
							dataArr[i].grandson[infos[j].name] = infos[j].value;
						}

					}

					subEditBaseData( data.result , _this ); 
					
					return
				}
				
				if( has( tt , 'submit-data' ) ){
					
					for (var i = 0; i < infoRows.length; i++) {
						
						infos = infoRows[i].getElementsByClassName('text');
						oneInfo = {};

						for (var j = 0; j < infos.length; j++) {

							if( Elf.utils.trim( infos[j].value ) === '' ){

								infos[j].focus();
								
							    Elf.components.toast({	
							        holdtime:1000,
							        text:'请填写完整再提交！',
							        target:document.body
							    });	
							    
								return
								
							}

						}

					}

					for (var i = 0; i < infoRows.length; i++) {
						infos = infoRows[i].getElementsByClassName('text');
						
						for (var j = 0; j < infos.length; j++) {
							
							dataArr[i].grandson[infos[j].name] = infos[j].value;
						}

					}
					subEditBaseData( data.result , _this ); 
					
					return
				}
				
				if( has( tt , 'addrow' ) ){

					_this.addRow(data);

				}
				
			})
		}		
		
		//添加一条数据
		BasiSituation5.prototype.addRow = function( data ){
			
			var dataArr = data.result.childrenList[0].grandsonList;
			var infoRows = this.warp.getElementsByClassName('row');
			console.log( infoRows , dataArr );
		
			for (var i = 0; i < dataArr.length; i++) {
				infos = infoRows[i].getElementsByClassName('text');
				console.log( dataArr[i] );
				for (var j = 0; j < infos.length; j++) {
					
					dataArr[i].grandson[infos[j].name] = infos[j].value;
				}

			}			
			
			dataArr.push({
				
				"grandson":{
					
					"fIsDel" : 0
				}
			});

			this.randerData( data );	

			
		}
		
		//删除基地
		BasiSituation5.prototype.removeRow = function(data){
			var data = data;
			var _this = this;	
			this.warp.addEventListener('click', function(ev){
	
				var has,
					e,
					tt,
					parent,
					index,
					dataArr;
				has = Elf.utils.hasClass;		
				e = Elf.getEvent(ev);
				tt = Elf.getEventSource(ev);
				dataArr = data.result.childrenList[0].grandsonList;
				
				if( has( tt , 'btn' ) && has( tt ,'removerow' ) ){
					
					while( !has( tt.parentNode , 'row' ) && tt.nodeName !== 'BODY' ){
						tt = tt.parentNode;
					}
					
					if( tt.nodeName === 'BODY' ){
						
						return
					}
					parent = tt.parentNode;
					index = Elf.utils.attr( parent , 'data-index');
					console.log( dataArr );
					dataArr[index-1].grandson.fIsDel = 1;
					Elf.utils.remove(parent);
					
				}
				
			});
			
		}

		//隐藏按钮
		BasiSituation5.prototype.hideBtns = function(){
			var hash,
				btns,
				inputs;
				
			hash = window.location.hash.substring(1);	
			btns = this.warp.querySelectorAll('input.btn');
			inputs = this.warp.querySelectorAll('input');	
			
			if( hash.indexOf('newPage') !== -1 ){
								
				for (var i = 0; i < inputs.length; i++) {
					inputs[i].disabled = 'disabled';
				}			
				for (var i = 0; i < btns.length; i++) {
					
					Elf.effects.hidden(btns[i]);
				}			
			}
		}
	})();	
 	
/***** 专业科室 > 专业科室基本情况表6 ******/	
	;(function(){
	
		//查询数据
		function getBaseData( _this ) {
		    var args = {};
		    args.fType = "20";
		    args.fTableNumber = "departmentDirector";
		    var service = {
		        serviceModule: serviceInfo.serviceModule,
		        serviceNumber: '100090080',
		        token: use_info.token,
		        args: {"parent":args}
		    };
	
		    commonLogic.serviceCaller(service, function (data) {
		        
		        //console.log(JSON.stringify(data));
		        if(data.flag == "true"){
		        	
		        	console.log( data );

					_this.init( data );

					
	
		        }else{
		        	
		            Elf.components.toast({text:data.error});
		        }
		    });
		}
		
		//发送数据
		function subEditBaseData( args , _this ) {
		    var service = {
		        serviceModule: serviceInfo.serviceModule,
		        serviceNumber: '100090090',
		        token: use_info.token,
		        args: args
		    };
		    commonLogic.serviceCaller(service, function (data) {
		        //console.log(JSON.stringify(data));

		        if(data.flag == "true"){
		            //alert(data.result);
				    Elf.components.toast({
				    	
				        holdtime:500,
				        text:'修改成功',
				        target:document.body
				        
				    });	

		        }else{
		            Elf.components.toast({text:data.error});
		        }
		    });
		}		
		
		
		function BasiSituation6(){
			this.content = document.querySelector(".elf_fiexd_center");
			this.warp = $creatE('div' ,'grid6 full');
			this.form = $creatE( 'form' , 'full p10');
			
			getBaseData( this );
		}
		
		//专业科室基本情况表6接口
		zyjdModuleByGao.basiSituation6 = BasiSituation6;
		
		BasiSituation6.prototype.init = function( data ){
			
			data.result.parent.fTableNumber = data.result.parent.fTableNumber || "departmentDirector";
			
			
			if( !data.result.fDepartmentCode && data.result.fDepartmentCode != 0 ){
				
				data.result.fDepartmentCode = "";
				
			}			
			
			if( !data.result.fChildrenId && data.result.fChildrenId != 0 ){
				
				data.result.fChildrenId = "";
				
			}	
			
			if( !data.result.childrenList.length ){

				data.result.childrenList = [					
					{
						"children":{							
							"fOrder" : 0
						},						
						"grandsonList":[]
					}				
				];
			}

			this.creatGrid6( data );
		}
		
		//生成表格
		BasiSituation6.prototype.creatGrid6 = function( dataObj ){
			var _this = this;
			var getData = dataObj;
			Elf.components.ajax({
				
				url:"zyjd-professional-grid6.html",
				dataType:"html",
				data:{id:1,ccc:"ccc"},
				
				success:function(data){
					
					_this.warp.innerHTML = data;
					_this.content.innerHTML = '';
					Elf.controls.appendTo( _this.warp, _this.form);					
					Elf.controls.appendTo( _this.form, _this.content);
					
					_this.randerData(getData);
					_this.btnFn( getData );					
					_this.textAreaLimit();
				},
				error:function(xhr){
					
					console.info(xhr);
				}
			});			
			
		}
		
		//渲染数据
		BasiSituation6.prototype.randerData = function( dataObj ){
			
			var data = dataObj.result.childrenList;
			var textData = {},
				areaData = {};

			for (var i = 0; i < data.length; i++) {
				
				if( data[i].children.fOrder == 0 ){

					textData = data[i].children;
					areaData = data[i].grandsonList[0] ? data[i].grandsonList[0] : {};
					break;
				}
				
			}

			areaData.grandson = areaData.grandson || {}; 
			var texts = this.warp.querySelectorAll('input.text');
			var textsArea = this.warp.querySelectorAll('textarea');
			var radios = this.warp.getElementsByClassName('radio-dsqk');
			

			for (var i = 0; i < texts.length; i++) {
				
				if( textData[texts[i].name] || textData[texts[i].name] == 0  ){
					
					texts[i].value = textData[texts[i].name];
					Elf.utils.addClass(texts[i] , 'has-value');
				}else{
					
					texts[i].value = "";
					Elf.utils.removeClass(texts[i] , 'has-value');
					
				}
				
				texts[i].addEventListener('blur',function(){
					
					if( Elf.utils.trim( this.value ) !== ''  ){
						
						Elf.utils.addClass( this , 'has-value');
						
					}else{
						
						Elf.utils.removeClass( this , 'has-value');
					}
					
				})

			}
			
			for (var i = 0; i < radios.length; i++) {
				
				if( radios[i].value === textData[radios[0].name] ){
					
					radios[i].checked = "checked"; 

				}

			}

			for (var i = 0; i < textsArea.length; i++) {
				
				textsArea[i].value = areaData.grandson[textsArea[i].name] ? areaData.grandson[textsArea[i].name] : "";
//				console.log(  )
				if( Elf.utils.trim( textsArea[i].value) !== ''  ){
					
					Elf.utils.addClass( textsArea[i] , 'has-value');
					
				}else{
					
					Elf.utils.removeClass( textsArea[i] , 'has-value');	
				}
				
				textsArea[i].addEventListener('blur' , function(){
					
					if( Elf.utils.trim( this.value) !== ''  ){
						
						Elf.utils.addClass( this , 'has-value');
						
					}else{
						
						Elf.utils.removeClass( this , 'has-value');	
					}					
					
				});
				
				
			}
			
		}

		//按钮绑定事件
		BasiSituation6.prototype.btnFn = function( dataObj ){
			var _this = this;			
			var getData = dataObj;
			this.warp.addEventListener('click', function(ev){
		
				var has,
					e,
					tt,
					dataObj,
					isCheckAudio,
					radioWarp,
					allTexts,
					radios;

				dataObj = null;
				isCheckAudio = false;
				has = Elf.utils.hasClass;		
				e = Elf.getEvent(ev);
				tt = Elf.getEventSource(ev);
					
				allTexts = this.querySelectorAll('.text');
				radios = this.querySelectorAll('.radio-dsqk');				
				radioWarp = this.querySelector('.radio-warp');
				Elf.utils.removeClass( radioWarp , 'focus' );
				
				if( has( tt , 'save-data' ) ){

					_this.getTableInfo( getData );

					subEditBaseData( getData.result , _this );
					return
				}
				if( has( tt , 'submit-data' ) ){
					
					for (var i = 0; i < allTexts.length; i++) {
						
						if( Elf.utils.trim( allTexts[i].value) === '' ){
							
							allTexts[i].focus();
							
						    Elf.components.toast({	
						        holdtime:1000,
						        text:'请填写完整再提交',
						        target:document.body
						    });							
						
							return
						}
						
					}
					
					for (var i = 0; i < radios.length; i++) {
						
						if( radios[i].checked ){
							
							isCheckAudio = true;

						}

					}
					//单选框是否选中
					if( !isCheckAudio ){
						
						Elf.utils.addClass( radioWarp , 'focus' );
						radios[0].focus();
						
					    Elf.components.toast({	
					        holdtime:1000,
					        text:'请选择导师情况',
					        target:document.body
					    });							
					
						return						
						
					}
					
					_this.getTableInfo( getData );	
					subEditBaseData( getData.result , _this );	

					return
				}
				
			});

		}		
		
		//textarea字数限制
		BasiSituation6.prototype.textAreaLimit = function(){
			
			var aTextArea = this.warp.getElementsByClassName('textarea');
			
			var isInputing = false;

			for (var i = 0; i < aTextArea.length; i++) {
				
				aTextArea[i].nextElementSibling.innerHTML = 2500 - aTextArea[i].value.length;

				aTextArea[i].addEventListener('compositionstart', function(){

				    isInputing = true;
				})
				
				aTextArea[i].addEventListener('compositionend', function(){
					
					var _this = this;
					
					this.nextElementSibling.innerHTML = Math.max(0 , (2500 - Elf.utils.trim( this.value ).length));
					
					if( (2500 - Elf.utils.trim( this.value ).length) <= 10 ){
						
						Elf.utils.addClass(_this.nextElementSibling , 'red');
						
					}else{
						
						Elf.utils.removeClass(_this.nextElementSibling , 'red');
						
					}
					isInputing = false;
				    
				    

				})
				
				aTextArea[i].addEventListener('input' , function(){
					
					var _this = this;
					
					if( !isInputing ){
						
						this.nextElementSibling.innerHTML = Math.max(0 , (2500 - Elf.utils.trim( this.value ).length));			
						if( (2500 - Elf.utils.trim( this.value ).length) <= 10 ){
							
							Elf.utils.addClass(_this.nextElementSibling , 'red');
							
						}else{
							
							Elf.utils.removeClass(_this.nextElementSibling , 'red');
							
						}
					
					
					}
					
					if( Elf.utils.trim( this.value ).length > 2500 ){

					    Elf.components.toast({

					        holdtime:1000,
					        text:'内容过多，请输入少于2500字',
					        target:box
					    });
						this.value = this.value.substring( 0 , 2500 );
						
					}
				});
			}
						
		}
		
		//隐藏按钮
		BasiSituation6.prototype.hideBtns = function(){
			var hash,
				btns;
				
			hash = window.location.hash.substring(1);
		
			btns = this.warp.getElementsByClassName('btn');
			
			console.log( hash );
			if( hash.indexOf('newPage') !== -1 ){
				
				for (var i = 0; i < btns.length; i++) {
					
					Elf.effects.hidden(btns[i]);
				}			
			}
		
		}	
		
		//获取表单数据
		BasiSituation6.prototype.getTableInfo = function(dataObj){
			var texts,
				infoObj,
				radios,
				data,
				returnData;
			texts = this.warp.querySelectorAll('input.text');
			textsArea = this.warp.querySelectorAll('textarea');
			radios = this.warp.getElementsByClassName('radio-dsqk');
			infoObj = {};
			data = dataObj.result.childrenList;

			for (var i = 0; i < data.length; i++) {
				
				if( data[i].children.fOrder == 0 ){

					returnData = data[i];

					break
				}
				
			}
	
//			console.log( data[0].children === textData , areaData === data[0].grandsonList[0] );
//			return;	
			for (var i = 0; i < texts.length; i++) {
				
				returnData.children[texts[i].name] = texts[i].value;

			}
			
			for (var i = 0; i < radios.length; i++) {
				
				if( radios[i].checked ){
					
					returnData.children[radios[i].name] = radios[i].value;
				}
			}
			
			returnData.grandsonList[0] = returnData.grandsonList[0] || {"grandson":{}};
			for (var i = 0; i < textsArea.length; i++) {
				
				returnData.grandsonList[0].grandson[textsArea[i].name] = textsArea[i].value;
			}			

			return dataObj.result;
			
		}
	})();
	
})()
